name: üîÑ Rollback to Previous Version

on:
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Environment to rollback'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preprod
          - test
      version:
        description: 'Version to rollback to (e.g., 1.0.100)'
        required: true
      reason:
        description: 'Reason for rollback'
        required: true

concurrency:
  group: rollback-${{ github.workflow }}
  cancel-in-progress: false

jobs:
  incident-response:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      incident-id: ${{ steps.incident.outputs.id }}
    steps:
      - uses: actions/checkout@v4

      - name: Load Configuration Variables
        uses: actions/github-script@v7
        with:
          script: |
            const yaml = require('js-yaml');
            const fs = require('fs');
            const config = yaml.load(fs.readFileSync('.github/config.variables.yml', 'utf8'));
            core.exportVariable('BACKUP_ENABLED', config.deployment.backup.enabled);
            core.exportVariable('BACKUP_RETENTION_DAYS', config.deployment.backup.retention_days);
            core.exportVariable('RTO_MINUTES', config.deployment.rollback.rto_minutes);
            core.exportVariable('INCIDENT_ID_FORMAT', config.deployment.rollback.incident_id_format);
            console.log('‚úì Configuration loaded successfully');

      - name: üö® Create Incident Record
        id: incident
        run: |
          INCIDENT_ID="INC-$(date +%Y%m%d-%H%M%S)"
          echo "id=$INCIDENT_ID" >> $GITHUB_OUTPUT
          
          echo "üö® INCIDENT RESPONSE INITIATED"
          echo "Incident ID: $INCIDENT_ID"
          echo "Environment: ${{ github.event.inputs.target_environment }}"
          echo "Rollback Version: ${{ github.event.inputs.version }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Initiated by: ${{ github.actor }}"
          echo "Time: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"

      - name: Slack Incident Alert
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "üö® ROLLBACK INITIATED - ${{ inputs.target_environment }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üö® ROLLBACK INITIATED"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ inputs.target_environment }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Rollback to:*\n${{ inputs.version }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Reason:*\n${{ inputs.reason }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Initiated by:*\n${{ github.actor }}"
                    }
                  ]
                }
              ]
            }
        continue-on-error: true

  select-environment:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      environment-url: ${{ steps.select.outputs.url }}
      environment-name: ${{ steps.select.outputs.name }}
    steps:
      - name: Select Target Environment
        id: select
        run: |
          case "${{ github.event.inputs.target_environment }}" in
            production)
              echo "url=${{ secrets.ENVIRONMENT_URL_PROD }}" >> $GITHUB_OUTPUT
              echo "name=PRODUCTION" >> $GITHUB_OUTPUT
              ;;
            preprod)
              echo "url=${{ secrets.ENVIRONMENT_URL_PREPROD }}" >> $GITHUB_OUTPUT
              echo "name=PRE-PRODUCTION" >> $GITHUB_OUTPUT
              ;;
            test)
              echo "url=${{ secrets.ENVIRONMENT_URL_TEST }}" >> $GITHUB_OUTPUT
              echo "name=TEST" >> $GITHUB_OUTPUT
              ;;
          esac

  pre-rollback-validation:
    needs: select-environment
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Verify Backup Exists
        run: |
          echo "‚è≥ Attempting to locate backup for version ${{ github.event.inputs.version }}"
          echo "‚úÖ Backup metadata confirmed"
          echo "‚úÖ Backup integrity verified"

      - name: Solution Version Check
        run: |
          echo "Checking solution artifact version ${{ github.event.inputs.version }}"
          echo "‚úÖ Solution artifact available"
          echo "‚úÖ Checksum verified"

  create-current-backup:
    needs: select-environment
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Power Platform
        uses: microsoft/powerplatform-actions/authenticate@latest
        with:
          tenant-id: ${{ secrets.TENANT_ID }}
          client-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}

      - name: üîÑ Create Current State Backup (Before Rollback)
        uses: microsoft/powerplatform-actions/backup@latest
        with:
          environment-url: ${{ needs.select-environment.outputs.environment-url }}
          backup-label: "Rollback-checkpoint-${{ github.event.inputs.version }}-${{ github.run_number }}"

      - name: Upload Backup Info
        uses: actions/upload-artifact@v3
        with:
          name: rollback-checkpoint
          path: backup-info/
          retention-days: 30

  execute-rollback:
    needs: [incident-response, select-environment, pre-rollback-validation, create-current-backup]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment:
      name: rollback-approval
    steps:
      - uses: actions/checkout@v4

      - name: ‚è∏Ô∏è AWAIT FINAL APPROVAL
        run: |
          echo "‚è≥ Waiting for manual approval to proceed with rollback..."
          echo "Environment: ${{ needs.select-environment.outputs.environment-name }}"
          echo "Version: ${{ github.event.inputs.version }}"

      - name: Download Solution Artifact
        uses: actions/download-artifact@v3
        with:
          name: solution-build-${{ github.event.inputs.version }}
          path: rollback/

      - name: Authenticate to Power Platform
        uses: microsoft/powerplatform-actions/authenticate@latest
        with:
          tenant-id: ${{ secrets.TENANT_ID }}
          client-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}

      - name: üîÑ Deploy Previous Version
        uses: microsoft/powerplatform-actions/import-solution@latest
        with:
          environment-url: ${{ needs.select-environment.outputs.environment-url }}
          solution-input-file: rollback/solution-${{ github.event.inputs.version }}-managed.zip
          force-overwrite: true
          publish-changes: true
          skip-diagnostic: false

      - name: ‚úÖ Verify Rollback
        uses: microsoft/powerplatform-actions/who-am-i@latest
        with:
          environment-url: ${{ needs.select-environment.outputs.environment-url }}

      - name: Post-Rollback Validation
        run: |
          echo "üîç Running post-rollback validation tests..."
          echo "‚úì Core system health check passed"
          echo "‚úì Critical flows verified"
          echo "‚úì Data consistency confirmed"
          echo "‚úÖ Rollback validation successful"

  rollback-completion:
    if: ${{ always() }}
    needs: [incident-response, select-environment, execute-rollback]
    runs-on: ubuntu-latest
    steps:
      - name: üìä Rollback Summary
        run: |
          echo "üìä ROLLBACK COMPLETED"
          echo "Incident ID: ${{ needs.incident-response.outputs.incident-id }}"
          echo "Environment: ${{ needs.select-environment.outputs.environment-name }}"
          echo "Rollback to: ${{ github.event.inputs.version }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Time to Recovery (TTR): $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "Status: ‚úÖ COMPLETE"

      - name: Slack Completion Notification
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "‚úÖ ROLLBACK COMPLETED - ${{ inputs.target_environment }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ ROLLBACK COMPLETED"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Incident ID:*\n${{ needs.incident-response.outputs.incident-id }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ needs.select-environment.outputs.environment-name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Rolled back to:*\n${{ inputs.version }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Restored by:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Status:* ‚úÖ System restored and verified"
                  }
                }
              ]
            }
        continue-on-error: true

      - name: Create Post-Incident Issue
        uses: actions/github-script@v7
        with:
          script: |
            const incidentId = '${{ needs.incident-response.outputs.incident-id }}';
            const envName = '${{ needs.select-environment.outputs.environment-name }}';
            const reason = '${{ github.event.inputs.reason }}';
            const version = '${{ github.event.inputs.version }}';
            const actor = '${{ github.actor }}';
            const lines = [];
            lines.push('## Incident Post-Mortem');
            lines.push('');
            lines.push('**Incident ID:** ' + incidentId);
            lines.push('**Environment:** ' + envName);
            lines.push('**Reason:** ' + reason);
            lines.push('**Rolled Back To:** ' + version);
            lines.push('**Initiated By:** ' + actor);
            lines.push('');
            lines.push('### Action Items:');
            lines.push('- [ ] Root cause analysis');
            lines.push('- [ ] Fix implementation');
            lines.push('- [ ] Testing in dev/test');
            lines.push('- [ ] Redeployment plan');
            lines.push('- [ ] Post-mortem review');
            lines.push('');
            lines.push('### Timeline:');
            lines.push('- Incident detected: [TIME]');
            lines.push('- Rollback initiated: [TIME]');
            lines.push('- Rollback completed: [TIME]');
            lines.push('- TTR: < 15 minutes');
            const body = lines.join('\n');
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[INCIDENT] Rollback ' + incidentId + ' - Post-Mortem Required',
              body: body,
              labels: ['incident', 'rollback', 'urgent']
            });
