name: Export and Extract Power Platform Solution

on:
  workflow_dispatch:

# ============================================================================
# GLOBAL ENVIRONMENT VARIABLES - Update these in one place
# ============================================================================
env:
  # Power Platform Configuration
  ENVIRONMENT_URL: ${{ vars.ENVIRONMENT_URL }}
  APP_ID: ${{ vars.APP_ID }}
  TENANT_ID: ${{ vars.TENANT_ID }}
  CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
  SOLUTION_NAME: "Samlab"
  SOLUTION_VERSION: "1.0.0"
  
  # Git Configuration
  GIT_USER_NAME: "GitHub Actions"
  GIT_USER_EMAIL: "actions@github.com"
  
  # Directory Paths
  SOLUTIONS_DIR: solutions
  MANAGED_SOLUTIONS_DIR: managed-solutions
  SOLUTION_TYPE: Unmanaged
  
  # Artifact Configuration
  ARTIFACT_NAME: power-platform-solutions
  ARTIFACT_RETENTION_DAYS: "30"

jobs:
  export-extract:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      # ======================================================================
      # DEBUG: Display all variables and environment
      # ======================================================================
      - name: Display All Environment Variables
        run: |
          echo "=========================================="
          echo "WORKFLOW VARIABLES AND CONFIGURATION"
          echo "=========================================="
          echo "Power Platform Configuration:"
          echo "  - ENVIRONMENT_URL: ${{ env.ENVIRONMENT_URL }}"
          echo "  - SOLUTION_NAME: ${{ env.SOLUTION_NAME }}"
          echo "  - SOLUTION_VERSION: ${{ env.SOLUTION_VERSION }}"
          echo ""
          echo "Git Configuration:"
          echo "  - GIT_USER_NAME: ${{ env.GIT_USER_NAME }}"
          echo "  - GIT_USER_EMAIL: ${{ env.GIT_USER_EMAIL }}"
          echo ""
          echo "Directory Configuration:"
          echo "  - SOLUTIONS_DIR: ${{ env.SOLUTIONS_DIR }}"
          echo "  - MANAGED_SOLUTIONS_DIR: ${{ env.MANAGED_SOLUTIONS_DIR }}"
          echo "  - SOLUTION_TYPE: ${{ env.SOLUTION_TYPE }}"
          echo ""
          echo "Artifact Configuration:"
          echo "  - ARTIFACT_NAME: ${{ env.ARTIFACT_NAME }}"
          echo "  - ARTIFACT_RETENTION_DAYS: ${{ env.ARTIFACT_RETENTION_DAYS }}"
          echo ""
          echo "Runner Information:"
          echo "  - Runner Temp: ${{ runner.temp }}"
          echo "  - Runner OS: ${{ runner.os }}"
          echo "  - GitHub Actor: ${{ github.actor }}"
          echo "  - GitHub Repository: ${{ github.repository }}"
          echo "  - GitHub Branch: ${{ github.ref }}"
          echo "=========================================="
          echo ""

      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display Checkout Info
        run: |
          echo "[STEP] Repository checked out successfully"
          echo "[INFO] Current directory:"
          pwd
          echo "[INFO] Git repository information:"
          git status
          echo "[INFO] Current branch:"
          git branch -vv

      - name: Install Power Platform Tools
        run: |
          echo "[STEP] Installing Power Platform Tools and PAC CLI..."
          echo "[INFO] Installing PAC CLI via dotnet..."
          dotnet tool install --global Microsoft.PowerApps.CLI.Tool 2>&1 | tail -1
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          echo "[SUCCESS] Power Platform Tools installation completed"
          echo "[INFO] Verifying PAC CLI:"
          $HOME/.dotnet/tools/pac help > /dev/null 2>&1 && echo "[SUCCESS] PAC CLI verified" || echo "[ERROR] PAC CLI verification failed"

      - name: Display PAC CLI Info
        run: |
          echo "[STEP] Displaying PAC CLI information..."
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          echo "[INFO] PAC CLI Available Commands:"
          $HOME/.dotnet/tools/pac help 2>&1 | head -20

      - name: Validate Required Variables
        run: |
          echo "[STEP] Validating required environment variables..."
          MISSING_VARS=""
          
          if [ -z "${{ env.ENVIRONMENT_URL }}" ]; then
            echo "[ERROR] ENVIRONMENT_URL is not set"
            MISSING_VARS="${MISSING_VARS}ENVIRONMENT_URL, "
          else
            echo "[OK] ENVIRONMENT_URL: ${{ env.ENVIRONMENT_URL }}"
          fi
          
          if [ -z "${{ env.APP_ID }}" ]; then
            echo "[ERROR] APP_ID is not set"
            MISSING_VARS="${MISSING_VARS}APP_ID, "
          else
            echo "[OK] APP_ID is set"
          fi
          
          if [ -z "${{ env.TENANT_ID }}" ]; then
            echo "[ERROR] TENANT_ID is not set"
            MISSING_VARS="${MISSING_VARS}TENANT_ID, "
          else
            echo "[OK] TENANT_ID is set"
          fi
          
          if [ -z "${{ env.CLIENT_SECRET }}" ]; then
            echo "[ERROR] CLIENT_SECRET is not set"
            MISSING_VARS="${MISSING_VARS}CLIENT_SECRET, "
          else
            echo "[OK] CLIENT_SECRET is set"
          fi
          
          if [ ! -z "$MISSING_VARS" ]; then
            echo ""
            echo "[ERROR] Missing or empty variables: ${MISSING_VARS%,*}"
            echo ""
            echo "REQUIRED ACTION:"
            echo "Go to GitHub repository → Settings → Secrets and variables → Variables"
            echo "Add these repository variables:"
            echo "  - ENVIRONMENT_URL: https://your-org.crm.dynamics.com"
            echo "  - APP_ID: your-app-id"
            echo "  - TENANT_ID: your-tenant-id"
            echo ""
            echo "Add this repository secret:"
            echo "  - CLIENT_SECRET: your-client-secret"
            exit 1
          fi
          
          echo "[SUCCESS] All required variables are set"

      - name: Authenticate to Power Platform
        run: |
          echo "[STEP] Authenticating to Power Platform environment..."
          echo "[INFO] Environment URL: ${{ env.ENVIRONMENT_URL }}"
          echo "[INFO] Using application-id: ${{ env.APP_ID }}"
          echo "[INFO] Using tenant: ${{ env.TENANT_ID }}"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          echo "[INFO] Attempting service principal authentication with cleartext caching..."
          echo "[INFO] Using PAC CLI auth create with:"
          echo "  - applicationId: ${{ env.APP_ID }}"
          echo "  - clientSecret: ***"
          echo "  - tenant: ${{ env.TENANT_ID }}"
          echo "  - environment: ${{ env.ENVIRONMENT_URL }}"
          $HOME/.dotnet/tools/pac auth create \
            --applicationId "${{ env.APP_ID }}" \
            --clientSecret "${{ env.CLIENT_SECRET }}" \
            --tenant "${{ env.TENANT_ID }}" \
            --environment "${{ env.ENVIRONMENT_URL }}" \
            --accept-cleartext-caching || {
              echo "[ERROR] Authentication failed"
              echo "[INFO] PAC CLI auth create usage:"
              $HOME/.dotnet/tools/pac auth create --help 2>&1 | head -30 || true
              exit 1
            }
          
          echo "[SUCCESS] Authenticated successfully"
          echo "[INFO] Current authentication context:"
          $HOME/.dotnet/tools/pac auth who || true

      - name: Verify Environment Connection
        run: |
          echo "[STEP] Verifying connection to Power Platform environment..."
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          echo "[INFO] Environment: ${{ env.ENVIRONMENT_URL }}"
          
          # List solutions to verify connectivity
          echo "[INFO] Attempting to list solutions..."
          $HOME/.dotnet/tools/pac solution list || {
            echo "[WARNING] Could not list solutions (may be due to permissions), proceeding with export..."
          }
          echo "[SUCCESS] Environment verified"

      - name: Export Solution as Managed
        run: |
          echo "[STEP] Exporting solution as managed..."
          echo "[INFO] Solution Name: ${{ env.SOLUTION_NAME }}"
          echo "[INFO] Output File: ${{ runner.temp }}/${{ env.SOLUTION_NAME }}_managed.zip"
          echo "[INFO] Environment: ${{ env.ENVIRONMENT_URL }}"
          
          export PATH="$PATH:$HOME/.dotnet/tools"
          
          $HOME/.dotnet/tools/pac solution export \
            --environment "${{ env.ENVIRONMENT_URL }}" \
            --name "${{ env.SOLUTION_NAME }}" \
            --path "${{ runner.temp }}/${{ env.SOLUTION_NAME }}_managed.zip" \
            --managed \
            --overwrite || {
              echo "[ERROR] Failed to export managed solution"
              exit 1
            }
          
          echo "[SUCCESS] Managed solution exported"
          echo "[INFO] File size:"
          ls -lh "${{ runner.temp }}/${{ env.SOLUTION_NAME }}_managed.zip"

      - name: Export Solution as Unmanaged
        run: |
          echo "[STEP] Exporting solution as unmanaged..."
          echo "[INFO] Solution Name: ${{ env.SOLUTION_NAME }}"
          echo "[INFO] Output File: ${{ runner.temp }}/${{ env.SOLUTION_NAME }}_unmanaged.zip"
          echo "[INFO] Environment: ${{ env.ENVIRONMENT_URL }}"
          
          export PATH="$PATH:$HOME/.dotnet/tools"
          
          $HOME/.dotnet/tools/pac solution export \
            --environment "${{ env.ENVIRONMENT_URL }}" \
            --name "${{ env.SOLUTION_NAME }}" \
            --path "${{ runner.temp }}/${{ env.SOLUTION_NAME }}_unmanaged.zip" \
            --overwrite || {
              echo "[ERROR] Failed to export unmanaged solution"
              exit 1
            }
          
          echo "[SUCCESS] Unmanaged solution exported"
          echo "[INFO] File size:"
          ls -lh "${{ runner.temp }}/${{ env.SOLUTION_NAME }}_unmanaged.zip"

      - name: Unpack Unmanaged Solution
        run: |
          echo "[STEP] Unpacking unmanaged solution..."
          echo "[INFO] Solution File: ${{ runner.temp }}/${{ env.SOLUTION_NAME }}_unmanaged.zip"
          echo "[INFO] Output Folder: ${{ env.SOLUTIONS_DIR }}/${{ env.SOLUTION_NAME }}"
          echo "[INFO] Solution Type: ${{ env.SOLUTION_TYPE }}"
          
          export PATH="$PATH:$HOME/.dotnet/tools"
          
          $HOME/.dotnet/tools/pac solution unpack \
            --zipfile "${{ runner.temp }}/${{ env.SOLUTION_NAME }}_unmanaged.zip" \
            --folder "${{ env.SOLUTIONS_DIR }}/${{ env.SOLUTION_NAME }}" \
            --packagetype ${{ env.SOLUTION_TYPE }} || {
              echo "[ERROR] Failed to unpack solution"
              exit 1
            }
          
          echo "[SUCCESS] Solution unpacked successfully"
          echo "[INFO] Extracted files:"
          find "${{ env.SOLUTIONS_DIR }}/${{ env.SOLUTION_NAME }}" -type f | head -20

      - name: Create Managed Solutions Directory
        run: |
          echo "[STEP] Creating managed solutions directory..."
          mkdir -p "${{ env.MANAGED_SOLUTIONS_DIR }}"
          echo "[SUCCESS] Directory created: ${{ env.MANAGED_SOLUTIONS_DIR }}"

      - name: Copy Managed Solution
        run: |
          echo "[STEP] Copying managed solution..."
          cp "${{ runner.temp }}/${{ env.SOLUTION_NAME }}_managed.zip" "${{ env.MANAGED_SOLUTIONS_DIR }}/"
          echo "[SUCCESS] Managed solution copied"
          echo "[INFO] File details:"
          ls -lh "${{ env.MANAGED_SOLUTIONS_DIR }}/${{ env.SOLUTION_NAME }}_managed.zip"

      - name: Display Directory Structure
        run: |
          echo "[INFO] Directory structure after export:"
          echo ""
          echo "Solutions Directory Structure:"
          find "${{ env.SOLUTIONS_DIR }}" -type f 2>/dev/null | head -20 || echo "  (No files yet)"
          echo ""
          echo "Managed Solutions Directory Structure:"
          ls -lh "${{ env.MANAGED_SOLUTIONS_DIR }}" || echo "  (Empty)"

      - name: Configure Git
        run: |
          echo "[STEP] Configuring git..."
          git config --global user.name "${{ env.GIT_USER_NAME }}"
          git config --global user.email "${{ env.GIT_USER_EMAIL }}"
          echo "[SUCCESS] Git configured"
          echo "[INFO] Git config:"
          git config --list | grep user

      - name: Commit and Push Changes
        run: |
          echo "[STEP] Committing and pushing changes..."
          echo "[INFO] Git status before commit:"
          git status
          
          # Check .gitignore to see if it's excluding our files
          echo "[INFO] Checking .gitignore..."
          if [ -f ".gitignore" ]; then
            echo "Current .gitignore contents:"
            cat .gitignore
          else
            echo ".gitignore not found"
          fi
          
          # Explicitly add files
          echo "[INFO] Adding solutions directory..."
          git add "${{ env.SOLUTIONS_DIR }}/" -v || echo "[WARNING] Could not add solutions dir"
          
          echo "[INFO] Adding managed-solutions directory..."
          git add "${{ env.MANAGED_SOLUTIONS_DIR }}/" -v || echo "[WARNING] Could not add managed-solutions dir"
          
          # Force add if needed
          echo "[INFO] Force adding ZIP files in case they're excluded..."
          find "${{ env.MANAGED_SOLUTIONS_DIR }}" -name "*.zip" -exec git add -f {} \; 2>/dev/null || true
          
          echo "[INFO] Changes staged:"
          git status
          
          echo "[INFO] Staged files summary:"
          git diff --cached --name-status | head -20 || echo "[INFO] No changes to show"
          
          echo "[INFO] Creating commit..."
          git commit -m "feat: Export and extract ${{ env.SOLUTION_NAME }} solution
          
          - Exported managed solution to ${{ env.MANAGED_SOLUTIONS_DIR }}/
          - Extracted unmanaged solution to ${{ env.SOLUTIONS_DIR }}/
          - Environment: ${{ env.ENVIRONMENT_URL }}
          - Solution: ${{ env.SOLUTION_NAME }}
          - Version: ${{ env.SOLUTION_VERSION }}
          
          Triggered by: ${{ github.actor }}" || echo "[INFO] No changes to commit"
          
          echo "[INFO] Pushing to origin..."
          git push origin HEAD || echo "[WARNING] Push failed or no changes"
          echo "[SUCCESS] Changes committed and pushed"

      - name: Upload Artifacts
        if: always()
        run: |
          echo "[STEP] Preparing artifacts for upload..."
          echo "[INFO] Artifact Name: ${{ env.ARTIFACT_NAME }}"
          echo "[INFO] Retention Days: ${{ env.ARTIFACT_RETENTION_DAYS }}"
          echo ""
          echo "[INFO] Solutions directory contents:"
          find "${{ env.SOLUTIONS_DIR }}" -type f 2>/dev/null | wc -l
          echo ""
          echo "[INFO] Managed solutions directory contents:"
          ls -lh "${{ env.MANAGED_SOLUTIONS_DIR }}" 2>/dev/null || echo "  (Directory may not exist)"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            ${{ env.SOLUTIONS_DIR }}/
            ${{ env.MANAGED_SOLUTIONS_DIR }}/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Final Summary
        if: always()
        run: |
          echo "=========================================="
          echo "WORKFLOW EXECUTION SUMMARY"
          echo "=========================================="
          echo "[INFO] Workflow Status: ${{ job.status }}"
          echo "[INFO] Solution: ${{ env.SOLUTION_NAME }}"
          echo "[INFO] Environment: ${{ env.ENVIRONMENT_URL }}"
          echo "[INFO] Extraction Type: ${{ env.SOLUTION_TYPE }}"
          echo ""
          echo "[INFO] Final directory structure:"
          find . -name "${{ env.SOLUTION_NAME }}" -o -name "*managed*" 2>/dev/null | head -10
          echo "=========================================="
