name: Export and Extract Power Platform Solution

on:
  workflow_dispatch:

# ============================================================================
# GLOBAL ENVIRONMENT VARIABLES - Update these in one place
# ============================================================================
env:
  # Power Platform Configuration
  ENVIRONMENT_URL: "https://indev.crm.dynamics.com"
  SOLUTION_NAME: "Samlab"
  SOLUTION_VERSION: "1.0.0"
  
  # Git Configuration
  GIT_USER_NAME: "GitHub Actions"
  GIT_USER_EMAIL: "actions@github.com"
  
  # Directory Paths
  SOLUTIONS_DIR: solutions
  MANAGED_SOLUTIONS_DIR: managed-solutions
  SOLUTION_TYPE: Unmanaged
  
  # Artifact Configuration
  ARTIFACT_NAME: power-platform-solutions
  ARTIFACT_RETENTION_DAYS: "30"

jobs:
  export-extract:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      # ======================================================================
      # DEBUG: Display all variables and environment
      # ======================================================================
      - name: Display All Environment Variables
        run: |
          echo "=========================================="
          echo "WORKFLOW VARIABLES AND CONFIGURATION"
          echo "=========================================="
          echo "Power Platform Configuration:"
          echo "  - ENVIRONMENT_URL: ${{ env.ENVIRONMENT_URL }}"
          echo "  - SOLUTION_NAME: ${{ env.SOLUTION_NAME }}"
          echo "  - SOLUTION_VERSION: ${{ env.SOLUTION_VERSION }}"
          echo ""
          echo "Git Configuration:"
          echo "  - GIT_USER_NAME: ${{ env.GIT_USER_NAME }}"
          echo "  - GIT_USER_EMAIL: ${{ env.GIT_USER_EMAIL }}"
          echo ""
          echo "Directory Configuration:"
          echo "  - SOLUTIONS_DIR: ${{ env.SOLUTIONS_DIR }}"
          echo "  - MANAGED_SOLUTIONS_DIR: ${{ env.MANAGED_SOLUTIONS_DIR }}"
          echo "  - SOLUTION_TYPE: ${{ env.SOLUTION_TYPE }}"
          echo ""
          echo "Artifact Configuration:"
          echo "  - ARTIFACT_NAME: ${{ env.ARTIFACT_NAME }}"
          echo "  - ARTIFACT_RETENTION_DAYS: ${{ env.ARTIFACT_RETENTION_DAYS }}"
          echo ""
          echo "Runner Information:"
          echo "  - Runner Temp: ${{ runner.temp }}"
          echo "  - Runner OS: ${{ runner.os }}"
          echo "  - GitHub Actor: ${{ github.actor }}"
          echo "  - GitHub Repository: ${{ github.repository }}"
          echo "  - GitHub Branch: ${{ github.ref }}"
          echo "=========================================="
          echo ""

      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display Checkout Info
        run: |
          echo "[STEP] Repository checked out successfully"
          echo "[INFO] Current directory:"
          pwd
          echo "[INFO] Git repository information:"
          git status
          echo "[INFO] Current branch:"
          git branch -vv

      - name: Install Power Platform Tools
        run: |
          echo "[STEP] Installing Power Platform Tools and PAC CLI..."
          
          # Check if dotnet is installed
          echo "[INFO] Checking for dotnet..."
          which dotnet || {
            echo "[ERROR] dotnet not found, checking if available..."
          }
          
          # Install PAC CLI using dotnet tool
          echo "[INFO] Installing PAC CLI via dotnet..."
          dotnet tool install --global Microsoft.PowerApps.CLI.Tool || {
            echo "[WARNING] Installation failed, trying alternative method..."
            dotnet tool update --global Microsoft.PowerApps.CLI.Tool --add-source https://api.nuget.org/v3/index.json || true
          }
          
          echo "[SUCCESS] Power Platform Tools installation attempted"
          echo "[INFO] Checking pac command location:"
          which pac || echo "[WARNING] pac not found yet, checking PATH..."
          
          # Add dotnet tools to PATH if needed
          export PATH="$PATH:$HOME/.dotnet/tools"
          echo "[INFO] Updated PATH: $PATH"
          
          # Verify PAC installation
          echo "[INFO] Verifying PAC CLI:"
          pac --version || {
            echo "[ERROR] PAC CLI not available"
            echo "[INFO] Available in PATH:"
            $HOME/.dotnet/tools/pac --version || echo "[ERROR] PAC not found in tools directory either"
          }

      - name: Display PAC CLI Info
        run: |
          echo "[STEP] Displaying PAC CLI information..."
          
          # Ensure PATH includes dotnet tools
          export PATH="$PATH:$HOME/.dotnet/tools"
          
          echo "[INFO] PAC CLI Version:"
          $HOME/.dotnet/tools/pac --version || echo "[ERROR] Could not get version"
          echo ""
          echo "[INFO] PAC CLI Available Commands:"
          $HOME/.dotnet/tools/pac help || true

      - name: Authenticate to Power Platform
        run: |
          echo "[STEP] Authenticating to Power Platform environment..."
          echo "[INFO] Environment URL: ${{ env.ENVIRONMENT_URL }}"
          echo "[INFO] Using application-id: ${{ secrets.POWERPLATFORM_APP_ID }}"
          echo "[INFO] Using tenant: ${{ secrets.POWERPLATFORM_TENANT_ID }}"
          
          # Ensure PATH includes dotnet tools
          export PATH="$PATH:$HOME/.dotnet/tools"
          
          echo "[INFO] Attempting service principal authentication with cleartext caching..."
          echo "[INFO] Using PAC CLI auth create with:"
          echo "  - applicationId: ${{ secrets.POWERPLATFORM_APP_ID }}"
          echo "  - clientSecret: ***"
          echo "  - tenant: ${{ secrets.POWERPLATFORM_TENANT_ID }}"
          echo "  - environment: ${{ env.ENVIRONMENT_URL }}"
          
          $HOME/.dotnet/tools/pac auth create \
            --applicationId "${{ secrets.POWERPLATFORM_APP_ID }}" \
            --clientSecret "${{ secrets.POWERPLATFORM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.POWERPLATFORM_TENANT_ID }}" \
            --environment "${{ env.ENVIRONMENT_URL }}" \
            --accept-cleartext-caching || {
              echo "[ERROR] Authentication failed"
              echo "[INFO] PAC CLI auth create usage:"
              $HOME/.dotnet/tools/pac auth create --help 2>&1 | head -30 || true
              exit 1
            }
          
          echo "[SUCCESS] Authenticated successfully"
          echo "[INFO] Current authentication context:"
          $HOME/.dotnet/tools/pac auth who || true

      - name: Verify Environment Connection
        run: |
          echo "[STEP] Verifying connection to Power Platform environment..."
          export PATH="$PATH:$HOME/.dotnet/tools"
          echo "[INFO] Environment: ${{ env.ENVIRONMENT_URL }}"
          
          # List solutions to verify connectivity
          echo "[INFO] Attempting to list solutions..."
          $HOME/.dotnet/tools/pac solution list || {
            echo "[WARNING] Could not list solutions (may be due to permissions), proceeding with export..."
          }
          echo "[SUCCESS] Environment verified"

      - name: Export Solution as Managed
        run: |
          echo "[STEP] Exporting solution as managed..."
          echo "[INFO] Solution Name: ${{ env.SOLUTION_NAME }}"
          echo "[INFO] Output File: ${{ runner.temp }}/${{ env.SOLUTION_NAME }}_managed.zip"
          echo "[INFO] Environment: ${{ env.ENVIRONMENT_URL }}"
          
          export PATH="$PATH:$HOME/.dotnet/tools"
          
          $HOME/.dotnet/tools/pac solution export \
            --environment "${{ env.ENVIRONMENT_URL }}" \
            --name "${{ env.SOLUTION_NAME }}" \
            --path "${{ runner.temp }}/${{ env.SOLUTION_NAME }}_managed.zip" \
            --managed \
            --overwrite || {
              echo "[ERROR] Failed to export managed solution"
              exit 1
            }
          
          echo "[SUCCESS] Managed solution exported"
          echo "[INFO] File size:"
          ls -lh "${{ runner.temp }}/${{ env.SOLUTION_NAME }}_managed.zip"

      - name: Export Solution as Unmanaged
        run: |
          echo "[STEP] Exporting solution as unmanaged..."
          echo "[INFO] Solution Name: ${{ env.SOLUTION_NAME }}"
          echo "[INFO] Output File: ${{ runner.temp }}/${{ env.SOLUTION_NAME }}_unmanaged.zip"
          echo "[INFO] Environment: ${{ env.ENVIRONMENT_URL }}"
          
          export PATH="$PATH:$HOME/.dotnet/tools"
          
          $HOME/.dotnet/tools/pac solution export \
            --environment "${{ env.ENVIRONMENT_URL }}" \
            --name "${{ env.SOLUTION_NAME }}" \
            --path "${{ runner.temp }}/${{ env.SOLUTION_NAME }}_unmanaged.zip" \
            --overwrite || {
              echo "[ERROR] Failed to export unmanaged solution"
              exit 1
            }
          
          echo "[SUCCESS] Unmanaged solution exported"
          echo "[INFO] File size:"
          ls -lh "${{ runner.temp }}/${{ env.SOLUTION_NAME }}_unmanaged.zip"

      - name: Unpack Unmanaged Solution
        run: |
          echo "[STEP] Unpacking unmanaged solution..."
          echo "[INFO] Solution File: ${{ runner.temp }}/${{ env.SOLUTION_NAME }}_unmanaged.zip"
          echo "[INFO] Output Folder: ${{ env.SOLUTIONS_DIR }}/${{ env.SOLUTION_NAME }}"
          echo "[INFO] Solution Type: ${{ env.SOLUTION_TYPE }}"
          
          export PATH="$PATH:$HOME/.dotnet/tools"
          
          $HOME/.dotnet/tools/pac solution unpack \
            --zipfile "${{ runner.temp }}/${{ env.SOLUTION_NAME }}_unmanaged.zip" \
            --outputfolder "${{ env.SOLUTIONS_DIR }}/${{ env.SOLUTION_NAME }}" \
            --type ${{ env.SOLUTION_TYPE }} || {
              echo "[ERROR] Failed to unpack solution"
              exit 1
            }
          
          echo "[SUCCESS] Solution unpacked successfully"
          echo "[INFO] Extracted files:"
          find "${{ env.SOLUTIONS_DIR }}/${{ env.SOLUTION_NAME }}" -type f | head -20

      - name: Create Managed Solutions Directory
        run: |
          echo "[STEP] Creating managed solutions directory..."
          mkdir -p "${{ env.MANAGED_SOLUTIONS_DIR }}"
          echo "[SUCCESS] Directory created: ${{ env.MANAGED_SOLUTIONS_DIR }}"

      - name: Copy Managed Solution
        run: |
          echo "[STEP] Copying managed solution..."
          cp "${{ runner.temp }}/${{ env.SOLUTION_NAME }}_managed.zip" "${{ env.MANAGED_SOLUTIONS_DIR }}/"
          echo "[SUCCESS] Managed solution copied"
          echo "[INFO] File details:"
          ls -lh "${{ env.MANAGED_SOLUTIONS_DIR }}/${{ env.SOLUTION_NAME }}_managed.zip"

      - name: Display Directory Structure
        run: |
          echo "[INFO] Directory structure after export:"
          echo ""
          echo "Solutions Directory Structure:"
          find "${{ env.SOLUTIONS_DIR }}" -type f 2>/dev/null | head -20 || echo "  (No files yet)"
          echo ""
          echo "Managed Solutions Directory Structure:"
          ls -lh "${{ env.MANAGED_SOLUTIONS_DIR }}" || echo "  (Empty)"

      - name: Configure Git
        run: |
          echo "[STEP] Configuring git..."
          git config --global user.name "${{ env.GIT_USER_NAME }}"
          git config --global user.email "${{ env.GIT_USER_EMAIL }}"
          echo "[SUCCESS] Git configured"
          echo "[INFO] Git config:"
          git config --list | grep user

      - name: Commit and Push Changes
        run: |
          echo "[STEP] Committing and pushing changes..."
          echo "[INFO] Git status before commit:"
          git status
          
          git add "${{ env.SOLUTIONS_DIR }}/" "${{ env.MANAGED_SOLUTIONS_DIR }}/" || echo "[INFO] No files to add"
          
          echo "[INFO] Changes staged:"
          git status
          
          git diff --cached --stat || echo "[INFO] No changes to show"
          
          git commit -m "feat: Export and extract ${{ env.SOLUTION_NAME }} solution
          
          - Exported managed solution to ${{ env.MANAGED_SOLUTIONS_DIR }}/
          - Extracted unmanaged solution to ${{ env.SOLUTIONS_DIR }}/
          - Environment: ${{ env.ENVIRONMENT_URL }}
          - Solution: ${{ env.SOLUTION_NAME }}
          - Version: ${{ env.SOLUTION_VERSION }}
          
          Triggered by: ${{ github.actor }}" || echo "[INFO] No changes to commit"
          
          echo "[INFO] Pushing to origin..."
          git push origin HEAD || echo "[WARNING] Push failed or no changes"
          echo "[SUCCESS] Changes committed and pushed"

      - name: Upload Artifacts
        if: always()
        run: |
          echo "[STEP] Preparing artifacts for upload..."
          echo "[INFO] Artifact Name: ${{ env.ARTIFACT_NAME }}"
          echo "[INFO] Retention Days: ${{ env.ARTIFACT_RETENTION_DAYS }}"
          echo ""
          echo "[INFO] Solutions directory contents:"
          find "${{ env.SOLUTIONS_DIR }}" -type f 2>/dev/null | wc -l
          echo ""
          echo "[INFO] Managed solutions directory contents:"
          ls -lh "${{ env.MANAGED_SOLUTIONS_DIR }}" 2>/dev/null || echo "  (Directory may not exist)"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            ${{ env.SOLUTIONS_DIR }}/
            ${{ env.MANAGED_SOLUTIONS_DIR }}/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Final Summary
        if: always()
        run: |
          echo "=========================================="
          echo "WORKFLOW EXECUTION SUMMARY"
          echo "=========================================="
          echo "[INFO] Workflow Status: ${{ job.status }}"
          echo "[INFO] Solution: ${{ env.SOLUTION_NAME }}"
          echo "[INFO] Environment: ${{ env.ENVIRONMENT_URL }}"
          echo "[INFO] Extraction Type: ${{ env.SOLUTION_TYPE }}"
          echo ""
          echo "[INFO] Final directory structure:"
          find . -name "${{ env.SOLUTION_NAME }}" -o -name "*managed*" 2>/dev/null | head -10
          echo "=========================================="
