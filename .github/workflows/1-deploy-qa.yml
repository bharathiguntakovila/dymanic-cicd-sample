name: Deploy Solution to QA

on:
  push:
    branches:
      - qa
    paths:
      - 'solutions/**'
      - '.github/workflows/1-deploy-qa.yml'
  workflow_dispatch:

# Configuration Variables (update these as needed)
env:
  ENVIRONMENT_URL: ${{ vars.ENVIRONMENT_URL }}
  SOLUTION_NAME: "Samlab"
  SOLUTION_DIR: solutions/Samlab
  APP_ID: ${{ vars.APP_ID }}
  CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
  TENANT_ID: ${{ vars.TENANT_ID }}

jobs:
  deploy-qa:
    runs-on: ubuntu-latest
    
    steps:
      - name: "[STEP 1] Display All Environment Variables"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] GitHub Actions Environment Information"
          echo "[INFO] ======================================"
          echo "[INFO] Workflow Name: ${{ github.workflow }}"
          echo "[INFO] Event: ${{ github.event_name }}"
          echo "[INFO] Branch: ${{ github.ref_name }}"
          echo "[INFO] Commit: ${{ github.sha }}"
          echo "[INFO] Actor: ${{ github.actor }}"
          echo "[INFO] Target Environment: QA"
          echo "[INFO] Solution Name: ${{ env.SOLUTION_NAME }}"
          echo "[INFO] Solution Directory: ${{ env.SOLUTION_DIR }}"
          echo "[INFO] ======================================"

      - name: "[STEP 2] Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "[STEP 3] Display Checkout Information"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Git Repository Status"
          echo "[INFO] ======================================"
          git status
          echo "[INFO] Current branch: $(git branch --show-current)"
          echo "[INFO] Last 3 commits:"
          git log --oneline -3
          echo "[INFO] ======================================"

      - name: "[STEP 4] Verify Solution Files Exist"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Verifying Solution Files"
          echo "[INFO] ======================================"
          if [ -d "${{ env.SOLUTION_DIR }}" ]; then
            echo "[SUCCESS] Solution directory found: ${{ env.SOLUTION_DIR }}"
            echo "[INFO] Directory contents:"
            find "${{ env.SOLUTION_DIR }}" -type f | head -20
            echo "[INFO] Total files: $(find "${{ env.SOLUTION_DIR }}" -type f | wc -l)"
          else
            echo "[ERROR] Solution directory not found: ${{ env.SOLUTION_DIR }}"
            exit 1
          fi
          echo "[INFO] ======================================"

      - name: "[STEP 5] Install Power Platform Tools"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Installing Power Platform CLI (PAC)"
          echo "[INFO] ======================================"
          dotnet tool install --global Microsoft.PowerApps.CLI.Tool 2>&1 | tail -1
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          echo "[SUCCESS] PAC CLI installed"
          echo "[INFO] Verifying installation..."
          $HOME/.dotnet/tools/pac help > /dev/null 2>&1 && echo "[SUCCESS] PAC CLI verified" || echo "[ERROR] PAC CLI verification failed"
          echo "[INFO] ======================================"

      - name: "[STEP 6] Display PAC CLI Information"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] PAC CLI Installation Details"
          echo "[INFO] ======================================"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          $HOME/.dotnet/tools/pac help 2>&1 | head -20
          echo "[INFO] ======================================"

      - name: "[STEP 7] Authenticate to QA Environment"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Authenticating to QA Environment"
          echo "[INFO] ======================================"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          $HOME/.dotnet/tools/pac auth create \
            --applicationId "${{ env.APP_ID }}" \
            --clientSecret "${{ env.CLIENT_SECRET }}" \
            --tenant "${{ env.TENANT_ID }}" \
            --environment "${{ env.ENVIRONMENT_URL }}" \
            --accept-cleartext-caching || {
            echo "[ERROR] Authentication failed"
            exit 1
          }
          echo "[SUCCESS] Authentication successful"
          echo "[INFO] ======================================"

      - name: "[STEP 8] Verify Environment Connection"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Verifying Connection to QA Environment"
          echo "[INFO] ======================================"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          $HOME/.dotnet/tools/pac solution list || {
            echo "[ERROR] Failed to connect to environment"
            exit 1
          }
          echo "[SUCCESS] Connected to QA environment"
          echo "[INFO] ======================================"

      - name: "[STEP 9] Pack Solution for Import"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Packing Solution Before Import"
          echo "[INFO] ======================================"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          mkdir -p /tmp/solutions
          $HOME/.dotnet/tools/pac solution pack \
            --zipfile "/tmp/solutions/${{ env.SOLUTION_NAME }}.zip" \
            --folder "${{ env.SOLUTION_DIR }}" \
            --packagetype Unmanaged || {
            echo "[ERROR] Solution pack failed"
            exit 1
          }
          echo "[SUCCESS] Solution packed successfully"
          if [ -f "/tmp/solutions/${{ env.SOLUTION_NAME }}.zip" ]; then
            FILESIZE=$(ls -lh "/tmp/solutions/${{ env.SOLUTION_NAME }}.zip" | awk '{print $5}')
            echo "[INFO] Package size: $FILESIZE"
          fi
          echo "[INFO] ======================================"

      - name: "[STEP 10] Import Solution to QA"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Importing Solution to QA Environment"
          echo "[INFO] ======================================"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          $HOME/.dotnet/tools/pac solution import \
            --environment "${{ env.ENVIRONMENT_URL }}" \
            --path "/tmp/solutions/${{ env.SOLUTION_NAME }}.zip" \
            --force-overwrite \
            --publish-changes || {
            echo "[ERROR] Solution import failed"
            exit 1
          }
          echo "[SUCCESS] Solution imported successfully"
          echo "[INFO] ======================================"

      - name: "[STEP 11] Verify Solution in QA"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Verifying Solution in QA Environment"
          echo "[INFO] ======================================"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          echo "[INFO] Available solutions:"
          $HOME/.dotnet/tools/pac solution list || {
            echo "[WARNING] Could not list solutions"
          }
          echo "[SUCCESS] Solution import verification complete"
          echo "[INFO] ======================================"

      - name: "[STEP 12] Create Deployment Summary"
        if: success()
        run: |
          echo "[SUCCESS] ======================================"
          echo "[SUCCESS] Deployment to QA Complete!"
          echo "[SUCCESS] ======================================"
          echo "[INFO] Solution: ${{ env.SOLUTION_NAME }}"
          echo "[INFO] Target Environment: QA"
          echo "[INFO] Environment URL: ${{ env.ENVIRONMENT_URL }}"
          echo "[INFO] Deployment Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "[INFO] Commit: ${{ github.sha }}"
          echo "[INFO] Branch: ${{ github.ref_name }}"
          echo "[SUCCESS] ======================================"

      - name: "[STEP 13] Upload Deployment Artifacts"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-deployment-artifacts
          path: /tmp/solutions/
          retention-days: 30
          if-no-files-found: warn

      - name: "[STEP 14] Deployment Failure Assistance"
        if: failure()
        run: |
          echo "[ERROR] ======================================"
          echo "[ERROR] Deployment to QA Failed!"
          echo "[ERROR] ======================================"
          echo "[ERROR] Please check:"
          echo "[ERROR] 1. QA_ENVIRONMENT_URL is correct in secrets"
          echo "[ERROR] 2. QA_APP_ID has permissions in QA environment"
          echo "[ERROR] 3. QA_CLIENT_SECRET is valid and not expired"
          echo "[ERROR] 4. Solution files are properly extracted"
          echo "[ERROR] 5. No conflicting solutions in QA"
          echo "[ERROR] ======================================"
