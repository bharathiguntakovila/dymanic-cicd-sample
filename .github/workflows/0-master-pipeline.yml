name: Master Pipeline Orchestrator

on:
  push:
    branches:
      - dev
    paths:
      - 'solutions/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  SOLUTION_NAME: "Samlab"

jobs:
  # ========================================================================
  # STAGE 1: QA (Automatic - No Approval)
  # ========================================================================
  stage-1-qa:
    name: "ğŸ“¦ Stage 1: Deploy to QA"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Starting QA Deployment"
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘            PIPELINE STAGE 1: QA DEPLOYMENT                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Status: â–¶ï¸  IN PROGRESS (Automatic)"
          echo "Solution: ${{ env.SOLUTION_NAME }}"
          echo "Triggered by: ${{ github.actor }}"
          echo ""

  deploy-qa:
    name: "ğŸŸ¦ QA Deployment"
    needs: stage-1-qa
    uses: ./.github/workflows/1-deploy-qa.yml@main
    with:
      environment_name: "QA"
    secrets: inherit

  # ========================================================================
  # MANUAL APPROVAL GATE FOR CAT
  # ========================================================================
  approve-cat:
    name: "â¸ï¸ Approval: Deploy to CAT"
    needs: deploy-qa
    runs-on: ubuntu-latest
    environment: cat-approval
    
    steps:
      - name: "âœ… CAT Deployment Approved"
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    APPROVAL GATE: CAT STAGE                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Previous Stage 1 (QA): SUCCESS"
          echo "ğŸ”“ Approval Status: APPROVED"
          echo "Approved by: ${{ github.actor }}"
          echo "Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "Proceeding to Stage 2: CAT Deployment"
          echo ""

  # ========================================================================
  # STAGE 2: CAT (After Approval)
  # ========================================================================
  stage-2-cat:
    name: "ğŸ“¦ Stage 2: Deploy to CAT"
    needs: approve-cat
    runs-on: ubuntu-latest
    
    steps:
      - name: "Starting CAT Deployment"
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘            PIPELINE STAGE 2: CAT DEPLOYMENT                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Status: â–¶ï¸  IN PROGRESS (After Approval)"
          echo "Solution: ${{ env.SOLUTION_NAME }}"
          echo ""

  deploy-cat:
    name: "ğŸŸ¨ CAT Deployment"
    needs: stage-2-cat
    uses: ./.github/workflows/2-deploy-cat.yml@main
    with:
      environment_name: "CAT"
    secrets: inherit

  # ========================================================================
  # MANUAL APPROVAL GATE FOR PRODUCTION
  # ========================================================================
  approve-prod:
    name: "â¸ï¸ Approval: Deploy to Production"
    needs: deploy-cat
    runs-on: ubuntu-latest
    environment: prod-approval
    
    steps:
      - name: "ğŸ”“ Production Deployment Approved"
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘               APPROVAL GATE: PRODUCTION STAGE                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸  CRITICAL: Production Deployment Approval"
          echo ""
          echo "âœ… Previous Stage 1 (QA): SUCCESS"
          echo "âœ… Previous Stage 2 (CAT): SUCCESS"
          echo "ğŸ”“ Production Approval: APPROVED"
          echo "Approved by: ${{ github.actor }}"
          echo "Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "âš ï¸  WARNING: Proceeding to Stage 3: Production Deployment"
          echo ""

  # ========================================================================
  # STAGE 3: PRODUCTION (After Approval)
  # ========================================================================
  stage-3-prod:
    name: "ğŸ“¦ Stage 3: Deploy to Production"
    needs: approve-prod
    runs-on: ubuntu-latest
    
    steps:
      - name: "Starting Production Deployment"
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         PIPELINE STAGE 3: PRODUCTION DEPLOYMENT              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Status: â–¶ï¸  IN PROGRESS (Live Environment)"
          echo "Solution: ${{ env.SOLUTION_NAME }}"
          echo "âš ï¸  WARNING: This is the LIVE environment"
          echo ""

  deploy-prod:
    name: "ğŸ”´ Production Deployment"
    needs: stage-3-prod
    uses: ./.github/workflows/3-deploy-production.yml@main
    with:
      environment_name: "Production"
    secrets: inherit

  # ========================================================================
  # FINAL SUMMARY
  # ========================================================================
  pipeline-complete:
    name: "ğŸ“Š Pipeline Summary"
    needs: [deploy-qa, deploy-cat, deploy-prod]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: "Pipeline Execution Summary"
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              PIPELINE EXECUTION COMPLETE                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Pipeline: Master Pipeline Orchestrator"
          echo "Solution: ${{ env.SOLUTION_NAME }}"
          echo "Source: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "Stages Executed:"
          echo "  âœ… Stage 1: QA - ${{ needs.deploy-qa.result }}"
          echo "  âœ… Stage 2: CAT - ${{ needs.deploy-cat.result }}"
          echo "  âœ… Stage 3: Production - ${{ needs.deploy-prod.result }}"
          echo ""
          echo "Overall Result:"
          if [ "${{ needs.deploy-qa.result }}" = "success" ] && \
             [ "${{ needs.deploy-cat.result }}" = "success" ] && \
             [ "${{ needs.deploy-prod.result }}" = "success" ]; then
            echo "  ğŸ‰ ALL STAGES PASSED SUCCESSFULLY"
          else
            echo "  âš ï¸  REVIEW FAILED STAGES"
          fi
          echo ""
          echo "Workflow URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    END OF PIPELINE REPORT                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
