name: Deploy Solution to Environment

on:
  push:
    branches:
      - qa
      - cat
      - main
    paths:
      - 'solutions/**'
      - '.github/workflows/deploy-solution.yml'
  workflow_dispatch:
  workflow_call:
    inputs:
      environment_name:
        description: 'Environment name (QA/CAT/Production)'
        required: true
        type: string
      target_branch:
        description: 'Target branch (qa/cat/main)'
        required: false
        default: 'qa'
        type: string

# ============================================================================
# GLOBAL ENVIRONMENT VARIABLES - Reusable for all environments
# ============================================================================
env:
  ENVIRONMENT_URL: ${{ vars.ENVIRONMENT_URL }}
  SOLUTION_NAME: "Samlab"
  SOLUTION_DIR: solutions/Samlab
  APP_ID: ${{ vars.APP_ID }}
  CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
  TENANT_ID: ${{ vars.TENANT_ID }}

jobs:
  deploy:
    name: "Deploy to ${{ inputs.environment_name || 'Environment' }}"
    runs-on: ubuntu-latest
    
    steps:
      - name: "[STEP 1] Display Environment Information"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] DEPLOYMENT INFORMATION"
          echo "[INFO] ======================================"
          echo "[INFO] Workflow: ${{ github.workflow }}"
          echo "[INFO] Event: ${{ github.event_name }}"
          echo "[INFO] Branch: ${{ github.ref_name }}"
          echo "[INFO] Commit: ${{ github.sha }}"
          echo "[INFO] Actor: ${{ github.actor }}"
          echo "[INFO] Target Environment: ${{ inputs.environment_name || 'QA' }}"
          echo "[INFO] Solution Name: ${{ env.SOLUTION_NAME }}"
          echo "[INFO] Solution Directory: ${{ env.SOLUTION_DIR }}"
          echo "[INFO] Environment URL: ${{ env.ENVIRONMENT_URL }}"
          echo "[INFO] ======================================"

      - name: "[STEP 2] Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "[STEP 3] Display Checkout Information"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Git Repository Status"
          echo "[INFO] ======================================"
          git status
          echo "[INFO] Current branch: $(git branch --show-current)"
          echo "[INFO] Last 3 commits:"
          git log --oneline -3
          echo "[INFO] ======================================"

      - name: "[STEP 4] Verify Solution Files Exist"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Verifying Solution Files"
          echo "[INFO] ======================================"
          if [ -d "${{ env.SOLUTION_DIR }}" ]; then
            echo "[SUCCESS] Solution directory found: ${{ env.SOLUTION_DIR }}"
            echo "[INFO] Directory contents:"
            find "${{ env.SOLUTION_DIR }}" -type f | head -20
            echo "[INFO] Total files: $(find "${{ env.SOLUTION_DIR }}" -type f | wc -l)"
          else
            echo "[ERROR] Solution directory not found: ${{ env.SOLUTION_DIR }}"
            exit 1
          fi
          echo "[INFO] ======================================"

      - name: "[STEP 5] Install Power Platform Tools"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Installing Power Platform CLI (PAC)"
          echo "[INFO] ======================================"
          dotnet tool install --global Microsoft.PowerApps.CLI.Tool 2>&1 | tail -1
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          echo "[SUCCESS] PAC CLI installed"
          echo "[INFO] Verifying installation..."
          $HOME/.dotnet/tools/pac help > /dev/null 2>&1 && echo "[SUCCESS] PAC CLI verified" || echo "[ERROR] PAC CLI verification failed"
          echo "[INFO] ======================================"

      - name: "[STEP 6] Display PAC CLI Information"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] PAC CLI Installation Details"
          echo "[INFO] ======================================"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          $HOME/.dotnet/tools/pac help 2>&1 | head -20
          echo "[INFO] ======================================"

      - name: "[STEP 7] Authenticate to Power Platform"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Authenticating to ${{ inputs.environment_name || 'QA' }} Environment"
          echo "[INFO] ======================================"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          $HOME/.dotnet/tools/pac auth create \
            --applicationId "${{ env.APP_ID }}" \
            --clientSecret "${{ env.CLIENT_SECRET }}" \
            --tenant "${{ env.TENANT_ID }}" \
            --environment "${{ env.ENVIRONMENT_URL }}" \
            --accept-cleartext-caching || {
            echo "[ERROR] Authentication failed"
            exit 1
          }
          echo "[SUCCESS] Authentication successful"
          echo "[INFO] ======================================"

      - name: "[STEP 8] Verify Environment Connection"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Verifying Connection to ${{ inputs.environment_name || 'QA' }} Environment"
          echo "[INFO] ======================================"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          $HOME/.dotnet/tools/pac solution list || {
            echo "[ERROR] Failed to connect to environment"
            exit 1
          }
          echo "[SUCCESS] Connected to ${{ inputs.environment_name || 'QA' }} environment"
          echo "[INFO] ======================================"

      - name: "[STEP 9] Pack Solution for Import"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Packing Solution Before Import"
          echo "[INFO] ======================================"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          mkdir -p /tmp/solutions
          $HOME/.dotnet/tools/pac solution pack \
            --zipfile "/tmp/solutions/${{ env.SOLUTION_NAME }}.zip" \
            --folder "${{ env.SOLUTION_DIR }}" \
            --packagetype Unmanaged || {
            echo "[ERROR] Solution pack failed"
            exit 1
          }
          echo "[SUCCESS] Solution packed successfully"
          if [ -f "/tmp/solutions/${{ env.SOLUTION_NAME }}.zip" ]; then
            FILESIZE=$(ls -lh "/tmp/solutions/${{ env.SOLUTION_NAME }}.zip" | awk '{print $5}')
            echo "[INFO] Package size: $FILESIZE"
          fi
          echo "[INFO] ======================================"

      - name: "[STEP 10] Import Solution to ${{ inputs.environment_name || 'QA' }}"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Importing Solution to ${{ inputs.environment_name || 'QA' }} Environment"
          echo "[INFO] ======================================"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          $HOME/.dotnet/tools/pac solution import \
            --environment "${{ env.ENVIRONMENT_URL }}" \
            --path "/tmp/solutions/${{ env.SOLUTION_NAME }}.zip" \
            --force-overwrite \
            --publish-changes || {
            echo "[ERROR] Solution import failed"
            exit 1
          }
          echo "[SUCCESS] Solution imported successfully"
          echo "[INFO] ======================================"

      - name: "[STEP 11] Verify Solution in ${{ inputs.environment_name || 'QA' }}"
        run: |
          echo "[INFO] ======================================"
          echo "[INFO] Verifying Solution in ${{ inputs.environment_name || 'QA' }} Environment"
          echo "[INFO] ======================================"
          PATH="$PATH:$HOME/.dotnet/tools"
          export PATH
          echo "[INFO] Available solutions:"
          $HOME/.dotnet/tools/pac solution list || {
            echo "[WARNING] Could not list solutions"
          }
          echo "[SUCCESS] Solution import verification complete"
          echo "[INFO] ======================================"

      - name: "[STEP 12] Create Deployment Summary"
        if: success()
        run: |
          echo "[SUCCESS] ======================================"
          echo "[SUCCESS] Deployment to ${{ inputs.environment_name || 'QA' }} Complete!"
          echo "[SUCCESS] ======================================"
          echo "[INFO] Solution: ${{ env.SOLUTION_NAME }}"
          echo "[INFO] Target Environment: ${{ inputs.environment_name || 'QA' }}"
          echo "[INFO] Environment URL: ${{ env.ENVIRONMENT_URL }}"
          echo "[INFO] Deployment Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "[INFO] Commit: ${{ github.sha }}"
          echo "[INFO] Branch: ${{ github.ref_name }}"
          echo "[SUCCESS] ======================================"

      - name: "[STEP 13] Upload Deployment Artifacts"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: solution-deployment-${{ inputs.environment_name || 'qa' }}
          path: /tmp/solutions/
          retention-days: 30
          if-no-files-found: warn

      - name: "[STEP 14] Deployment Failure Assistance"
        if: failure()
        run: |
          echo "[ERROR] ======================================"
          echo "[ERROR] Deployment to ${{ inputs.environment_name || 'QA' }} Failed!"
          echo "[ERROR] ======================================"
          echo "[ERROR] Please check:"
          echo "[ERROR] 1. ENVIRONMENT_URL is correct"
          echo "[ERROR] 2. APP_ID has permissions in the environment"
          echo "[ERROR] 3. CLIENT_SECRET is valid and not expired"
          echo "[ERROR] 4. TENANT_ID is correct"
          echo "[ERROR] 5. Solution files are properly extracted"
          echo "[ERROR] 6. No conflicting solutions in the target environment"
          echo "[ERROR] ======================================"
