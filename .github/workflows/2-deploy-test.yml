name: 2ï¸âƒ£ Deploy to TEST Environment

on:
  push:
    branches: [develop]
    paths:
      - 'src/**'
      - '.github/workflows/**'

concurrency:
  group: deploy-test-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-solution:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    outputs:
      solution-version: ${{ steps.version.outputs.version }}
      solution-file: solution-${{ steps.version.outputs.version }}-managed.zip
    steps:
      - uses: actions/checkout@v4

      - name: Generate version number
        id: version
        run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Build Version: $VERSION"

      - name: Authenticate to Power Platform
        uses: microsoft/powerplatform-actions/authenticate@latest
        with:
          tenant-id: ${{ secrets.TENANT_ID }}
          client-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}

      - name: Export Solution
        uses: microsoft/powerplatform-actions/export-solution@latest
        with:
          environment-url: ${{ secrets.ENVIRONMENT_URL_DEV }}
          solution-name: ${{ vars.SOLUTION_NAME }}
          solution-output-file: export/solution.zip
          managed: false

      - name: Pack Solution to Managed
        uses: microsoft/powerplatform-actions/pack-solution@latest
        with:
          solution-input-file: export/solution.zip
          solution-output-file: build/${{ steps.version.outputs.version }}/solution-${{ steps.version.outputs.version }}-managed.zip
          solution-type: 'Managed'
          overwrite: true

      - name: Generate Checksum
        run: |
          cd build/${{ steps.version.outputs.version }}
          sha256sum solution-*.zip > checksums.sha256
          cat checksums.sha256

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: solution-build-${{ steps.version.outputs.version }}
          path: |
            build/${{ steps.version.outputs.version }}/solution-*.zip
            build/${{ steps.version.outputs.version }}/checksums.sha256
          retention-days: 90

      - name: Upload to Nexus (Optional)
        if: ${{ env.NEXUS_ENABLED == 'true' }}
        env:
          NEXUS_URL: ${{ secrets.NEXUS_URL }}
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          set -e
          
          echo "::group::ðŸ“¦ Upload to Nexus Summary"
          
          ARTIFACT_FILE="build/${VERSION}/solution-${VERSION}-managed.zip"
          CHECKSUM_FILE="build/${VERSION}/checksums.sha256"
          
          if [ ! -f "$ARTIFACT_FILE" ]; then
            echo "âš ï¸  Artifact not found: $ARTIFACT_FILE - skipping Nexus upload"
            echo "::endgroup::"
            exit 0
          fi
          
          echo "Repository: $NEXUS_REPO"
          echo "Base Path: $NEXUS_BASE_PATH"
          echo "Version: $VERSION"
          
          # Upload managed solution
          echo ""
          echo "::group::â¬†ï¸  Uploading Managed Solution"
          RESPONSE=$(curl -s -w "\n%{http_code}" -u "$NEXUS_USERNAME:$NEXUS_PASSWORD" \
            -F "file=@${ARTIFACT_FILE}" \
            "$NEXUS_URL/repository/$NEXUS_REPO/$NEXUS_BASE_PATH/$VERSION/")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "204" ]; then
            echo "âœ… Solution uploaded successfully (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸  Upload response: HTTP $HTTP_CODE"
          fi
          echo "::endgroup::"
          
          # Upload checksum
          if [ -f "$CHECKSUM_FILE" ]; then
            echo ""
            echo "::group::â¬†ï¸  Uploading Checksum"
            curl -s -u "$NEXUS_USERNAME:$NEXUS_PASSWORD" \
              -F "file=@${CHECKSUM_FILE}" \
              "$NEXUS_URL/repository/$NEXUS_REPO/$NEXUS_BASE_PATH/$VERSION/" > /dev/null
            echo "âœ… Checksum uploaded"
            echo "::endgroup::"
          fi
          
          echo ""
          echo "âœ… Nexus upload complete"
          echo "::endgroup::"

  deploy-test:
    needs: build-solution
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Load Configuration Variables
        uses: actions/github-script@v7
        with:
          script: |
            const yaml = require('js-yaml');
            const fs = require('fs');
            const config = yaml.load(fs.readFileSync('.github/config.variables.yml', 'utf8'));
            core.exportVariable('SOLUTION_NAME', config.solution.name);
            core.exportVariable('MANAGED_SOLUTION_FILE', config.solution.managed_solution_file);
            core.exportVariable('BACKUP_ENABLED', config.deployment.backup.enabled);
            core.exportVariable('BACKUP_RETENTION_DAYS', config.deployment.backup.retention_days);
            core.exportVariable('IMPORT_TIMEOUT_MINUTES', config.deployment.timeouts.import_solution);
            core.exportVariable('NEXUS_ENABLED', config.nexus.enabled);
            core.exportVariable('NEXUS_REPO', config.nexus.repository.name);
            core.exportVariable('NEXUS_BASE_PATH', config.nexus.repository.base_path);
            core.exportVariable('NEXUS_TEST_RETENTION', config.nexus.upload.test.retention_days);
            console.log('âœ“ Configuration loaded successfully');

      - name: Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: solution-build-${{ needs.build-solution.outputs.solution-version }}
          path: deploy/

      - name: Download from Nexus (Fallback)
        if: ${{ env.NEXUS_ENABLED == 'true' && failure() }}
        continue-on-error: true
        env:
          NEXUS_URL: ${{ secrets.NEXUS_URL }}
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          VERSION: ${{ needs.build-solution.outputs.solution-version }}
        run: |
          echo "â¬‡ï¸  GitHub artifact download failed - attempting Nexus fallback..."
          
          ARTIFACT="solution-${VERSION}-managed.zip"
          
          echo "â¬‡ï¸  Downloading from Nexus (from config)..."
          echo "  Repository: $NEXUS_REPO"
          echo "  Base Path: $NEXUS_BASE_PATH"
          echo "  Version: $VERSION"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -u "$NEXUS_USERNAME:$NEXUS_PASSWORD" \
            -o "$ARTIFACT" \
            "$NEXUS_URL/repository/$NEXUS_REPO/$NEXUS_BASE_PATH/$VERSION/$ARTIFACT")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ -f "$ARTIFACT" ] && ([ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]); then
            mkdir -p deploy
            mv "$ARTIFACT" deploy/
            echo "âœ… Downloaded from Nexus (HTTP $HTTP_CODE)"
          else
            echo "âŒ Nexus download failed (HTTP $HTTP_CODE)" 
            exit 1
          fi

      - name: Authenticate to Power Platform
        uses: microsoft/powerplatform-actions/authenticate@latest
        with:
          tenant-id: ${{ secrets.TENANT_ID }}
          client-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}

      - name: ðŸ”„ Backup TEST Environment
        uses: microsoft/powerplatform-actions/backup@latest
        with:
          environment-url: ${{ secrets.ENVIRONMENT_URL_TEST }}
          backup-label: "Pre-deploy-${{ needs.build-solution.outputs.solution-version }}"
        continue-on-error: true

      - name: ðŸš€ Deploy to TEST
        uses: microsoft/powerplatform-actions/import-solution@latest
        with:
          environment-url: ${{ secrets.ENVIRONMENT_URL_TEST }}
          solution-input-file: deploy/solution-${{ needs.build-solution.outputs.solution-version }}-managed.zip
          force-overwrite: true
          publish-changes: true
          skip-diagnostic: false

      - name: Verify Deployment
        uses: microsoft/powerplatform-actions/who-am-i@latest
        with:
          environment-url: ${{ secrets.ENVIRONMENT_URL_TEST }}

  smoke-tests:
    needs: [build-solution, deploy-test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Smoke Tests
        run: |
          echo "ðŸ§ª Executing post-deployment smoke tests..."
          
          # Example smoke tests
          echo "âœ“ Test 1: Core table schemas"
          echo "âœ“ Test 2: Critical flows"
          echo "âœ“ Test 3: Security roles"
          echo "âœ“ Test 4: Plugin registration"
          
          echo "âœ… All smoke tests passed"

  notify-deployment:
    if: ${{ always() }}
    needs: [build-solution, deploy-test, smoke-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Release Notes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const version = '${{ needs.build-solution.outputs.solution-version }}';
            
            const release_notes = `## TEST Environment Deployment
            
            **Version:** ${version}
            **Commit:** ${{ github.sha }}
            **Branch:** develop
            **Triggered by:** ${{ github.actor }}
            
            ### Deployment Status
            âœ… Solution Built
            âœ… Deployed to TEST
            âœ… Smoke Tests Passed
            
            ### Artifacts
            - Solution: ${{ needs.build-solution.outputs.solution-file }}
            - Build Time: ${{ job.duration }}
            
            ### Next Steps
            1. QA testing in TEST environment
            2. Create release PR when ready
            3. Deploy to Pre-Prod/Production
            `;
            
            console.log(release_notes);

      - name: Slack Notification
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "âœ… Solution v${{ needs.build-solution.outputs.solution-version }} deployed to TEST",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*TEST Deployment Successful* ðŸš€\n*Version:* ${{ needs.build-solution.outputs.solution-version }}\n*Branch:* develop"
                  }
                }
              ]
            }
        continue-on-error: true

      - name: Create Deployment Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[TEST] Deployment v${{ needs.build-solution.outputs.solution-version }}`,
              body: `## Deployment to TEST\n\n- Version: ${{ needs.build-solution.outputs.solution-version }}\n- Commit: ${{ github.sha }}\n- Status: âœ… Complete\n\n### Testing Checklist:\n- [ ] Functional testing\n- [ ] Regression testing\n- [ ] Performance testing\n- [ ] Security validation`,
              labels: ['deployment', 'test', 'automated']
            });

      - name: ðŸ“‹ Workflow Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # 2ï¸âƒ£ TEST Deployment Summary
          
          ## Deployment Status: âœ… Complete
          
          | Item | Value |
          |------|-------|
          | **Version** | ${{ needs.build-solution.outputs.solution-version }} |
          | **Branch** | develop |
          | **Environment** | TEST |
          | **Trigger** | Manual Deployment |
          | **Duration** | ${{ job.duration }} mins |
          
          ## Workflow Steps
          - âœ… Build Solution
          - âœ… Deploy to TEST
          - âœ… Post-Deployment Validation
          - âœ… Upload to Nexus (Optional)
          
          ## Artifacts
          - Solution Package: `solution-${{ needs.build-solution.outputs.solution-version }}-managed.zip`
          - Retention: 90 days (GitHub) + 90 days (Nexus)
          
          ## Next Steps
          - Run integration tests
          - Validate in TEST environment
          - Prepare for PRODUCTION deployment
          
          ---
          *Generated by GitHub Actions*
          EOF
